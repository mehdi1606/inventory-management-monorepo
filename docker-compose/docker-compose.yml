version: '3.8'

services:
  # ================== KAFKA INFRASTRUCTURE ==================
  
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - stock-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_JMX_PORT: 9101
      KAFKA_JMX_HOSTNAME: kafka
    networks:
      - stock-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5

  kafdrop:
    image: obsidiandynamics/kafdrop:latest
    container_name: kafdrop
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "9000:9000"
    environment:
      KAFKA_BROKERCONNECT: kafka:29092
      JVM_OPTS: "-Xms32M -Xmx64M"
    networks:
      - stock-network

  # ================== DATABASES ==================

  postgres-product:
    image: postgres:15-alpine
    container_name: postgres-product
    environment:
      POSTGRES_DB: product_db
      POSTGRES_USER: product_user
      POSTGRES_PASSWORD: product_password
    ports:
      - "5432:5432"
    volumes:
      - postgres-product-data:/var/lib/postgresql/data
    networks:
      - stock-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U product_user -d product_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-inventory:
    image: postgres:15-alpine
    container_name: postgres-inventory
    environment:
      POSTGRES_DB: inventory_db
      POSTGRES_USER: inventory_user
      POSTGRES_PASSWORD: inventory_password
    ports:
      - "5433:5432"
    volumes:
      - postgres-inventory-data:/var/lib/postgresql/data
    networks:
      - stock-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U inventory_user -d inventory_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-movement:
    image: postgres:15-alpine
    container_name: postgres-movement
    environment:
      POSTGRES_DB: movement_db
      POSTGRES_USER: movement_user
      POSTGRES_PASSWORD: movement_password
    ports:
      - "5434:5432"
    volumes:
      - postgres-movement-data:/var/lib/postgresql/data
    networks:
      - stock-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U movement_user -d movement_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-location:
    image: postgres:15-alpine
    container_name: postgres-location
    environment:
      POSTGRES_DB: location_db
      POSTGRES_USER: location_user
      POSTGRES_PASSWORD: location_password
    ports:
      - "5435:5432"
    volumes:
      - postgres-location-data:/var/lib/postgresql/data
    networks:
      - stock-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U location_user -d location_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-quality:
    image: postgres:15-alpine
    container_name: postgres-quality
    environment:
      POSTGRES_DB: quality_db
      POSTGRES_USER: quality_user
      POSTGRES_PASSWORD: quality_password
    ports:
      - "5436:5432"
    volumes:
      - postgres-quality-data:/var/lib/postgresql/data
    networks:
      - stock-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U quality_user -d quality_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-user:
    image: postgres:15-alpine
    container_name: postgres-user
    environment:
      POSTGRES_DB: user_db
      POSTGRES_USER: user_user
      POSTGRES_PASSWORD: user_password
    ports:
      - "5437:5432"
    volumes:
      - postgres-user-data:/var/lib/postgresql/data
    networks:
      - stock-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_user -d user_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  postgres-alert:
    image: postgres:15-alpine
    container_name: postgres-alert
    environment:
      POSTGRES_DB: alert_db
      POSTGRES_USER: alert_user
      POSTGRES_PASSWORD: alert_password
    ports:
      - "5438:5432"
    volumes:
      - postgres-alert-data:/var/lib/postgresql/data
    networks:
      - stock-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U alert_user -d alert_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================== REDIS ==================

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - stock-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ================== SERVICES ==================

  product-service:
    build:
      context: ../product-service
      dockerfile: Dockerfile
    container_name: product-service
    depends_on:
      postgres-product:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8082:8082"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-product:5432/product_db
      SPRING_DATASOURCE_USERNAME: product_user
      SPRING_DATASOURCE_PASSWORD: product_password
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - stock-network
    restart: unless-stopped

  location-service:
    build:
      context: ../location-service
      dockerfile: Dockerfile
    container_name: location-service
    depends_on:
      postgres-location:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8085:8085"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-location:5432/location_db
      SPRING_DATASOURCE_USERNAME: location_user
      SPRING_DATASOURCE_PASSWORD: location_password
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - stock-network
    restart: unless-stopped

  inventory-service:
    build:
      context: ../inventory-service
      dockerfile: Dockerfile
    container_name: inventory-service
    depends_on:
      postgres-inventory:
        condition: service_healthy
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "8086:8086"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-inventory:5432/inventory_db
      SPRING_DATASOURCE_USERNAME: inventory_user
      SPRING_DATASOURCE_PASSWORD: inventory_password
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
    networks:
      - stock-network
    restart: unless-stopped

  movement-service:
    build:
      context: ../movement-service
      dockerfile: Dockerfile
    container_name: movement-service
    depends_on:
      postgres-movement:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8084:8084"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-movement:5432/movement_db
      SPRING_DATASOURCE_USERNAME: movement_user
      SPRING_DATASOURCE_PASSWORD: movement_password
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - stock-network
    restart: unless-stopped

  quality-service:
    build:
      context: ../quality-service
      dockerfile: Dockerfile
    container_name: quality-service
    depends_on:
      postgres-quality:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8087:8087"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-quality:5432/quality_db
      SPRING_DATASOURCE_USERNAME: quality_user
      SPRING_DATASOURCE_PASSWORD: quality_password
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - stock-network
    restart: unless-stopped

  auth-service:
    build:
      context: ../auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    depends_on:
      postgres-user:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8083:8083"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-user:5432/user_db
      SPRING_DATASOURCE_USERNAME: user_user
      SPRING_DATASOURCE_PASSWORD: user_password
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - stock-network
    restart: unless-stopped

  alert-service:
    build:
      context: ../alert-service
      dockerfile: Dockerfile
    container_name: alert-service
    depends_on:
      postgres-alert:
        condition: service_healthy
      kafka:
        condition: service_healthy
    ports:
      - "8088:8088"
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-alert:5432/alert_db
      SPRING_DATASOURCE_USERNAME: alert_user
      SPRING_DATASOURCE_PASSWORD: alert_password
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - stock-network
    restart: unless-stopped

  # ================== MONITORING ==================

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    networks:
      - stock-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3001:3001"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    networks:
      - stock-network
    restart: unless-stopped

  kafka-exporter:
    image: danielqsj/kafka-exporter:latest
    container_name: kafka-exporter
    command:
      - '--kafka.server=kafka:29092'
    ports:
      - "9308:9308"
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - stock-network
    restart: unless-stopped

  zipkin:
    image: openzipkin/zipkin:latest
    container_name: zipkin
    ports:
      - "9411:9411"
    networks:
      - stock-network
    restart: unless-stopped

networks:
  stock-network:
    driver: bridge

volumes:
  postgres-product-data:
  postgres-inventory-data:
  postgres-movement-data:
  postgres-location-data:
  postgres-quality-data:
  postgres-user-data:
  postgres-alert-data:
  prometheus-data:
  grafana-data: