package com.stock.inventoryservice.metrics;

import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.MeterRegistry;
import io.micrometer.core.instrument.Timer;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import jakarta.annotation.PostConstruct;

@Service
@Slf4j
public class KafkaMetricsService {

    private final MeterRegistry meterRegistry;
    private Counter messagesReceived;
    private Counter messagesProcessed;
    private Counter messagesFailed;

    public KafkaMetricsService(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
    }

    @PostConstruct
    public void init() {
        messagesReceived = Counter.builder("kafka.messages.received")
            .description("Total Kafka messages received")
            .tag("service", "inventory")
            .register(meterRegistry);

        messagesProcessed = Counter.builder("kafka.messages.processed")
            .description("Total messages successfully processed")
            .tag("service", "inventory")
            .register(meterRegistry);

        messagesFailed = Counter.builder("kafka.messages.failed")
            .description("Total messages that failed")
            .tag("service", "inventory")
            .register(meterRegistry);
    }

    public void incrementReceived() {
        messagesReceived.increment();
    }

    public void incrementProcessed() {
        messagesProcessed.increment();
    }

    public void incrementFailed() {
        messagesFailed.increment();
    }

    public Timer.Sample startTimer() {
        return Timer.start(meterRegistry);
    }

    public void recordTime(Timer.Sample sample, String operation) {
        sample.stop(Timer.builder("kafka.processing.time")
            .tag("operation", operation)
            .register(meterRegistry));
    }
}